{% extends "/student/student_base.html" %}
{% block title %}- Student Dashboard {% endblock %}
{% block content %}
    <style>    
        /* Content Sections */
        .content-section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(120, 119, 198, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-card {
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
        }

        .chart-placeholder {
            height: 300px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            margin-top: 15px;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Booking Status Styles */
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-confirmed {
            background: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-pending {
            background: rgba(249, 115, 22, 0.2);
            color: rgb(249, 115, 22);
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box input {
                width: 180px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">â˜°</button>
            <div class="page-title">
                <h1>Student Dashboard</h1>
                <p>Welcome back, {{user.user_first_name}}. Here's your current hostel status.</p>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="text" placeholder="Search...">
                </div>
                <div class="notification-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div class="notification-badge">{{ stats.pending_notifications }}</div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <!-- Current Booking -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.booking_status == 'Confirmed' %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            {% if stats.booking_status == 'Confirmed' %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.booking_status }}
                    </div>
                </div>
                <div class="stat-value">{{ stats.current_booking or 'None' }}</div>
                <div class="stat-label">Current Booking</div>
            </div>

            <!-- Payment Status -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19.4 15C19.2669 15.3044 19.1343 15.6087 19.0001 15.913C18.509 16.8954 17.8381 17.7487 17.0715 18.5153C15.6094 19.9774 13.695 20.761 11.7885 20.925C10.6824 21.0212 9.56619 20.8859 8.51563 20.5156C7.46506 20.1453 6.50492 19.5487 5.69697 18.7578C4.10469 17.1655 3.23828 15.0656 3.075 12.7885C2.91172 10.5114 3.52266 8.39063 4.875 6.75C5.46094 6.03281 6.15469 5.41406 6.9375 4.92188" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 4.5V12L15.375 13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.payment_status == 'Paid' %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            {% if stats.payment_status == 'Paid' %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.payment_status }}
                    </div>
                </div>
                <div class="stat-value">Ksh. {{ stats.balance_due or 0 }}</div>
                <div class="stat-label">Balance Due</div>
            </div>

            <!-- Days Remaining -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M8 7V3M16 7V3M7 11H17M5 21H19C19.5304 21 20.0391 20.7893 20.4142 20.4142C20.7893 20.0391 21 19.5304 21 19V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V19C3 19.5304 3.21071 20.0391 3.58579 20.4142C3.96086 20.7893 4.46957 21 5 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.days_remaining > 30 %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            {% if stats.days_remaining > 30 %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.days_remaining }} days
                    </div>
                </div>
                <div class="stat-value">{{ stats.days_remaining or 0 }}</div>
                <div class="stat-label">Days Remaining</div>
            </div>

            <!-- Notifications -->
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.pending_notifications == 0 %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            {% if stats.pending_notifications == 0 %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.pending_notifications }}
                    </div>
                </div>
                <div class="stat-value">{{ stats.pending_notifications }}</div>
                <div class="stat-label">Notifications</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="section-header">
                    <h3 class="section-title">Payment History</h3>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="changeChartPeriod('weekly')">Weekly</button>
                        <button class="btn btn-primary" onclick="changeChartPeriod('monthly')">Monthly</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="paymentHistoryChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="section-header">
                    <h3 class="section-title">Booking Status</h3>
                </div>
                <div class="chart-container">
                    <canvas id="bookingStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="content-section">
            <div class="section-header">
                <h3 class="section-title">Recent Bookings</h3>
                <div class="section-actions">
                    <a href="/student/bookings" class="btn btn-outline">View All</a>
                    <a href="/student/rooms" class="btn btn-primary">Book New Room</a>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Room</th>
                            <th>Hostel</th>
                            <th>Booking Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in recent_bookings %}
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <div>
                                            <div style="font-weight: 600;">{{booking.booking_reference_number}}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-light);">{{booking.booking_date.strftime('%Y-%m-%d')}}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{booking.room_number}}</td>
                                <td>{{booking.hostel_name}}</td>
                                <td>{{booking.booking_date.strftime('%b %d, %Y')}}</td>
                                <td>Ksh {{booking.room_price_per_sem}}</td>
                                <td>
                                    <span class="status status-{{booking.booking_status.lower()}}">
                                        {{booking.booking_status}}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        {% if booking.booking_status == 'Pending' %}
                                        <button class="action-btn" onclick="cancelBooking('{{booking.booking_id}}')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        {% endif %}
                                        <button class="action-btn" onclick="viewBookingDetails('{{booking.booking_id}}')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Mobile menu toggle
        document.getElementById('mobileMenuToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileToggle = document.getElementById('mobileMenuToggle');
            
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(event.target) && 
                !mobileToggle.contains(event.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        // Chart initialization
        let paymentHistoryChart, bookingStatusChart;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // Payment History Chart
            const paymentCtx = document.getElementById('paymentHistoryChart').getContext('2d');
            paymentHistoryChart = new Chart(paymentCtx, {
                type: 'line',
                data: {
                    labels: {{ stats.chart_data.payment_months | tojson }},
                    datasets: [{
                        label: 'Payments Made',
                        data: {{ stats.chart_data.payment_amounts | tojson }},
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return 'Ksh ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return 'Ksh ' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });

            // Booking Status Chart
            const bookingCtx = document.getElementById('bookingStatusChart').getContext('2d');
            bookingStatusChart = new Chart(bookingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Confirmed', 'Pending', 'Cancelled'],
                    datasets: [{
                        data: [
                            {{ stats.chart_data.booking_status.confirmed }},
                            {{ stats.chart_data.booking_status.pending }},
                            {{ stats.chart_data.booking_status.cancelled }}
                        ],
                        backgroundColor: [
                            'rgb(34, 197, 94)',  // Green for confirmed
                            'rgb(249, 115, 22)', // Orange for pending
                            'rgb(239, 68, 68)'   // Red for cancelled
                        ],
                        borderColor: 'rgba(20, 20, 30, 0.8)',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    }
                }
            });
        }

        function changeChartPeriod(period) {
            // Update button states
            document.querySelectorAll('.section-actions .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            event.target.classList.remove('btn-outline');
            event.target.classList.add('btn-primary');

            // Update chart title
            const chartTitle = document.querySelector('.chart-card .section-title');
            if (period === 'weekly') {
                chartTitle.textContent = 'Weekly Payments';
            } else {
                chartTitle.textContent = 'Monthly Payments';
            }
        }

        function viewBookingDetails(bookingId) {
            // Implement view booking details
            alert('View booking details for ID: ' + bookingId);
        }

        function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                alert('Booking cancelled: ' + bookingId);
            }
        }

        // Make charts responsive on window resize
        window.addEventListener('resize', function() {
            if (paymentHistoryChart) {
                paymentHistoryChart.resize();
            }
            if (bookingStatusChart) {
                bookingStatusChart.resize();
            }
        });
    </script>
{% endblock %}