{% extends "/admin/admin_base.html" %}
{% block title %} - Payments{% endblock %}
{% block content %}
    <style>
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(120, 119, 198, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3acf70;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #f9b208;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #ff4b7c;
            transform: translateY(-2px);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Status badges */
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-pending {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Payment method badges */
        .payment-method {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .pagination-info {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 600px;
            padding: 30px;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--text);
        }

        .payment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-group {
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .detail-value {
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-box input {
                width: 180px;
            }
            
            .filters-actions {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-group {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .payments-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .payment-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .payments-stats {
                grid-template-columns: 1fr;
            }
            
            .pagination {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
            <div class="page-title">
                <h1>Payments Management</h1>
                <p>Manage all payment transactions and revenue</p>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="text" placeholder="Search payments...">
                </div>
                <div class="notification-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div class="notification-badge">3</div>
                </div>
            </div>
        </div>

        <!-- Payments Stats -->
        <div class="payments-stats">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.total_payments_change >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            {% if stats.total_payments_change >= 0 %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.total_payments_change|abs }}%
                    </div>
                </div>
                <div class="stat-value">{{ stats.total_payments }}</div>
                <div class="stat-label">Total Payments</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C13.4 2 14.8 2.4 16 3.1C17.2 3.8 18.2 4.8 18.9 6C19.6 7.2 20 8.6 20 10C20 14.4 16.4 18 12 18C7.6 18 4 14.4 4 10C4 8.6 4.4 7.2 5.1 6C5.8 4.8 6.8 3.8 8 3.1C9.2 2.4 10.6 2 12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.total_revenue_change >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            {% if stats.total_revenue_change >= 0 %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.total_revenue_change|abs }}%
                    </div>
                </div>
                <div class="stat-value">Ksh. {{ "%.2f"|format(stats.total_revenue) }}</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 3C13.1819 3 14.3522 3.23279 15.4442 3.68508C16.5361 4.13738 17.5282 4.80031 18.364 5.63604C19.1997 6.47177 19.8626 7.46392 20.3149 8.55585C20.7672 9.64778 21 10.8181 21 12C21 13.1819 20.7672 14.3522 20.3149 15.4442C19.8626 16.5361 19.1997 17.5282 18.364 18.364C17.5282 19.1997 16.5361 19.8626 15.4442 20.3149C14.3522 20.7672 13.1819 21 12 21C10.8181 21 9.64778 20.7672 8.55585 20.3149C7.46392 19.8626 6.47177 19.1997 5.63604 18.364C4.80031 17.5282 4.13738 16.5361 3.68508 15.4442C3.23279 14.3522 3 13.1819 3 12C3 9.61305 3.94821 7.32387 5.63604 5.63604C7.32387 3.94821 9.61305 3 12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.successful_change >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            {% if stats.successful_change >= 0 %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.successful_change|abs }}%
                    </div>
                </div>
                <div class="stat-value">{{ stats.successful_payments }}</div>
                <div class="stat-label">Successful</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 3C13.1819 3 14.3522 3.23279 15.4442 3.68508C16.5361 4.13738 17.5282 4.80031 18.364 5.63604C19.1997 6.47177 19.8626 7.46392 20.3149 8.55585C20.7672 9.64778 21 10.8181 21 12C21 13.1819 20.7672 14.3522 20.3149 15.4442C19.8626 16.5361 19.1997 17.5282 18.364 18.364C17.5282 19.1997 16.5361 19.8626 15.4442 20.3149C14.3522 20.7672 13.1819 21 12 21C10.8181 21 9.64778 20.7672 8.55585 20.3149C7.46392 19.8626 6.47177 19.1997 5.63604 18.364C4.80031 17.5282 4.13738 16.5361 3.68508 15.4442C3.23279 14.3522 3 13.1819 3 12C3 9.61305 3.94821 7.32387 5.63604 5.63604C7.32387 3.94821 9.61305 3 12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-trend {% if stats.pending_change >= 0 %}trend-up{% else %}trend-down{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            {% if stats.pending_change >= 0 %}
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% else %}
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            {% endif %}
                        </svg>
                        {{ stats.pending_change|abs }}%
                    </div>
                </div>
                <div class="stat-value">{{ stats.pending_payments }}</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <!-- Filters and Actions -->
        <div class="filters-actions">
            <div class="filter-group">
                <select class="filter-select">
                    <option>All Status</option>
                    <option>Success</option>
                    <option>Pending</option>
                    <option>Failed</option>
                </select>
                <select class="filter-select">
                    <option>All Methods</option>
                    <option>Mpesa</option>
                    <option>Cash</option>
                </select>
                <select class="filter-select">
                    <option>Sort by: Newest</option>
                    <option>Sort by: Oldest</option>
                    <option>Sort by: Amount</option>
                    <option>Sort by: Student Name</option>
                </select>
            </div>
            <div>
                <button class="btn btn-primary" id="exportBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Payment ID</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Booking</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                        <tr>
                            <td>
                                {% if payment.user_first_name %}
                                    <div class="user-info">
                                        <div class="user-avatar">{{ payment.user_first_name[0] }}{{ payment.user_last_name[0] }}</div>
                                        <div>
                                            <div>{{ payment.user_first_name }} {{ payment.user_last_name }}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-light);">{{ payment.user_email }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div style="color: var(--text-light); font-style: italic;">No student linked</div>
                                {% endif %}
                            </td>
                            <td>{{ payment.payment_reference_number }}</td>
                            <td>Ksh. {{ "%.2f"|format(payment.payment_amount) }}</td>
                            <td>
                                <span class="payment-method">{{ payment.payment_method }}</span>
                            </td>
                            <td>{{ payment.payment_date }}</td>
                            <td>
                                <span class="status status-{{ payment.payment_status.lower() }}">
                                    {{ payment.payment_status }}
                                </span>
                            </td>
                            <td>
                                {% if payment.booking_reference_number %}
                                    {{ payment.booking_reference_number }}
                                {% else %}
                                    <span style="color: var(--text-light); font-style: italic;">No booking</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view-payment" data-id="{{ payment.payment_id }}">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    {% if payment.payment_status == 'Pending' %}
                                        <button class="btn btn-success approve-payment" data-id="{{ payment.payment_id }}" style="padding: 5px 10px; font-size: 0.8rem;">Approve</button>
                                        <button class="btn btn-danger reject-payment" data-id="{{ payment.payment_id }}" style="padding: 5px 10px; font-size: 0.8rem;">Reject</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info">Showing 1-{{ payments|length }} of {{ stats.total_payments }} payments</div>
                <div class="pagination-controls">
                    <button class="pagination-btn">Previous</button>
                    <button class="pagination-btn active">1</button>
                    <button class="pagination-btn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Payment Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="payment-details">
                <div class="detail-group">
                    <div class="detail-label">Payment ID</div>
                    <div class="detail-value" id="modalPaymentId">PAY-4821</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Reference Number</div>
                    <div class="detail-value" id="modalReferenceNumber">REF-123456</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Student Name</div>
                    <div class="detail-value" id="modalStudentName">Sarah Johnson</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Email</div>
                    <div class="detail-value" id="modalStudentEmail">sarah.j@email.com</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Amount</div>
                    <div class="detail-value" id="modalAmount">Ksh. 5,400.00</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Payment Method</div>
                    <div class="detail-value" id="modalPaymentMethod">Mpesa</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Payment Date</div>
                    <div class="detail-value" id="modalPaymentDate">15 Aug 2023</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Status</div>
                    <div class="detail-value" id="modalPaymentStatus">Success</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Booking Reference</div>
                    <div class="detail-value" id="modalBookingRef">BK-4821</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Hostel & Room</div>
                    <div class="detail-value" id="modalHostelRoom">University Hall • Room 204</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline close-modal">Close</button>
                <button class="btn btn-primary">Print Receipt</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const paymentModal = document.getElementById('paymentModal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const viewPaymentBtns = document.querySelectorAll('.view-payment');
        const approvePaymentBtns = document.querySelectorAll('.approve-payment');
        const rejectPaymentBtns = document.querySelectorAll('.reject-payment');
        const exportBtn = document.getElementById('exportBtn');

        // Set up event listeners
        function setupEventListeners() {
            // Mobile menu toggle
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });

            // View payment details
            viewPaymentBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    showPaymentDetails(paymentId);
                });
            });

            // Approve payment
            approvePaymentBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    updatePaymentStatus(paymentId, 'Success');
                });
            });

            // Reject payment
            rejectPaymentBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    updatePaymentStatus(paymentId, 'Failed');
                });
            });

            // Close modal
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    paymentModal.classList.remove('active');
                });
            });

            // Export button
            exportBtn.addEventListener('click', function() {
                exportPaymentsData();
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(event.target) && 
                    !mobileMenuToggle.contains(event.target) &&
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });

            // Close modal when clicking outside
            document.addEventListener('click', function(event) {
                if (event.target === paymentModal) {
                    paymentModal.classList.remove('active');
                }
            });
        }

        // Show payment details in modal
        function showPaymentDetails(paymentId) {
            // In a real application, you would fetch this data from an API
            // For now, we'll use the data from the table row
            const paymentRow = document.querySelector(`[data-id="${paymentId}"]`).closest('tr');
            const cells = paymentRow.querySelectorAll('td');
            
            const studentName = cells[0].querySelector('.user-info div:first-child')?.textContent || 'N/A';
            const studentEmail = cells[0].querySelector('.user-info div:last-child')?.textContent || 'N/A';
            const paymentRef = cells[1].textContent;
            const amount = cells[2].textContent;
            const method = cells[3].textContent;
            const date = cells[4].textContent;
            const status = cells[5].querySelector('.status').textContent;
            const bookingRef = cells[6].textContent;

            // Populate modal
            document.getElementById('modalPaymentId').textContent = paymentRef;
            document.getElementById('modalReferenceNumber').textContent = paymentRef;
            document.getElementById('modalStudentName').textContent = studentName;
            document.getElementById('modalStudentEmail').textContent = studentEmail;
            document.getElementById('modalAmount').textContent = amount;
            document.getElementById('modalPaymentMethod').textContent = method;
            document.getElementById('modalPaymentDate').textContent = date;
            document.getElementById('modalPaymentStatus').textContent = status;
            document.getElementById('modalBookingRef').textContent = bookingRef;

            // Show modal
            paymentModal.classList.add('active');
        }

        // Update payment status
        function updatePaymentStatus(paymentId, status) {
            const action = status === 'Success' ? 'approve' : 'reject';
            const paymentRow = document.querySelector(`[data-id="${paymentId}"]`).closest('tr');
            const studentName = paymentRow.querySelector('.user-info div:first-child')?.textContent || 'this payment';
            
            if (confirm(`Are you sure you want to ${action} ${studentName}'s payment?`)) {
                // Send AJAX request to update payment status
                fetch(`/admin/api/payments/${paymentId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Payment ${action}d successfully!`);
                        location.reload(); // Reload to reflect changes
                    } else {
                        alert('Error updating payment status: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating payment status');
                });
            }
        }

        // Export payments data
        function exportPaymentsData() {
            fetch('/admin/api/payments/export')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'payments_export.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('Payments data exported successfully!');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error exporting payments data');
                });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });
    </script>
{% endblock %}