{% extends "/admin/admin_base.html" %}
{% block title %} - Bookings Management{% endblock %}
{% block content %}
    <style>    
        /* Content Sections */
        .content-section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(120, 119, 198, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .stat-trend {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .positive {
            background: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
        }

        .negative {
            background: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-description {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 0;
        }

        /* Bookings Table */
        .bookings-table-container {
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            width: 18px;
            height: 18px;
            color: var(--text-light);
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 0.9rem;
            width: 250px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            transition: background-color 0.3s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-confirmed {
            background: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-pending {
            background: rgba(249, 115, 22, 0.2);
            color: rgb(249, 115, 22);
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .payment-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .payment-success {
            background: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
        }

        .payment-pending {
            background: rgba(249, 115, 22, 0.2);
            color: rgb(249, 115, 22);
        }

        .payment-failed {
            background: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Filter Section */
        .filter-section {
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-control {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        /* No Data State */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .table-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-box input {
                width: 200px;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">â˜°</button>
            <div class="page-title">
                <h1>Bookings Management</h1>
                <p>Manage and monitor all hostel bookings</p>
            </div>
            <div class="header-actions">
                <div class="notification-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div class="notification-badge">3</div>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Total Bookings</h3>
                    <span class="stat-trend {% if stats.total_change >= 0 %}positive{% else %}negative{% endif %}">
                        {{ stats.total_change }}%
                    </span>
                </div>
                <div class="stat-value">{{ stats.total_bookings }}</div>
                <p class="stat-description">This month</p>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Confirmed</h3>
                    <span class="stat-trend {% if stats.confirmed_change >= 0 %}positive{% else %}negative{% endif %}">
                        {{ stats.confirmed_change }}%
                    </span>
                </div>
                <div class="stat-value">{{ stats.confirmed_bookings }}</div>
                <p class="stat-description">Active bookings</p>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Pending</h3>
                    <span class="stat-trend {% if stats.pending_change >= 0 %}positive{% else %}negative{% endif %}">
                        {{ stats.pending_change }}%
                    </span>
                </div>
                <div class="stat-value">{{ stats.pending_bookings }}</div>
                <p class="stat-description">Awaiting action</p>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Cancelled</h3>
                    <span class="stat-trend {% if stats.cancelled_change >= 0 %}positive{% else %}negative{% endif %}">
                        {{ stats.cancelled_change }}%
                    </span>
                </div>
                <div class="stat-value">{{ stats.cancelled_bookings }}</div>
                <p class="stat-description">This month</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h3 style="margin-bottom: 15px;">Filter Bookings</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="form-control" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Pending">Pending</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Payment Status</label>
                    <select class="form-control" id="paymentFilter">
                        <option value="">All Payments</option>
                        <option value="Success">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Failed">Failed</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <input type="date" class="form-control" id="dateFrom">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">To</label>
                    <input type="date" class="form-control" id="dateTo">
                </div>
                
                <div class="filter-group">
                    <button class="btn btn-outline" onclick="resetFilters()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="bookings-table-container">
            <div class="table-header">
                <h2 class="table-title">Recent Bookings</h2>
                <div class="table-controls">
                    <div class="search-box">
                        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search bookings...">
                    </div>
                    <button class="btn btn-primary" onclick="exportBookings()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Export
                    </button>
                </div>
            </div>

            {% if bookings %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Student</th>
                            <th>Room</th>
                            <th>Hostel</th>
                            <th>Booking Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>
                                <strong>{{ booking.booking_reference_number }}</strong>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ booking.user_first_name }} {{ booking.user_last_name }}</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">
                                        {{ booking.user_email }}
                                    </div>
                                </div>
                            </td>
                            <td>{{ booking.room_number }}</td>
                            <td>{{ booking.hostel_name }}</td>
                            <td>{{ booking.booking_date.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <strong>Ksh {{ booking.room_price_per_sem }}</strong>
                            </td>
                            <td>
                                <span class="status-badge status-{{ booking.booking_status.lower() }}">
                                    {{ booking.booking_status }}
                                </span>
                            </td>
                            <td>
                                <span class="payment-status payment-{{ (booking.payment_status or 'pending').lower() }}">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        {% if booking.payment_status == 'Success' %}
                                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        {% elif booking.payment_status == 'Failed' %}
                                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        {% else %}
                                        <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        {% endif %}
                                    </svg>
                                    {{ booking.payment_status or 'Pending' }}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% if booking.booking_status == 'Pending' %}
                                    <button class="btn btn-success btn-sm" onclick="updateBookingStatus({{ booking.booking_id }}, 'Confirmed')">
                                        Confirm
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="updateBookingStatus({{ booking.booking_id }}, 'Cancelled')">
                                        Cancel
                                    </button>
                                    {% elif booking.booking_status == 'Confirmed' %}
                                    <button class="btn btn-warning btn-sm" onclick="updateBookingStatus({{ booking.booking_id }}, 'Pending')">
                                        Revert
                                    </button>
                                    {% endif %}
                                    
                                    <button class="btn btn-outline btn-sm" onclick="viewBookingDetails({{ booking.booking_id }})">
                                        View
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <div class="no-data-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3>No Bookings Found</h3>
                <p>There are no bookings matching your current filters.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Mobile menu toggle
        document.getElementById('mobileMenuToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileToggle = document.getElementById('mobileMenuToggle');
            
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(event.target) && 
                !mobileToggle.contains(event.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        // Update booking status
        function updateBookingStatus(bookingId, newStatus) {
            const statusText = newStatus.toLowerCase();
            if (confirm(`Are you sure you want to ${statusText} this booking?`)) {
                fetch(`/admin/api/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Booking ${statusText} successfully!`);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the booking status.');
                });
            }
        }

        // View booking details
        function viewBookingDetails(bookingId) {
            // In a real implementation, this would navigate to a detailed view
            alert(`Viewing details for booking ID: ${bookingId}`);
            // window.location.href = `/admin/bookings/${bookingId}`;
        }

        // Filter functionality
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const rows = document.querySelectorAll('.data-table tbody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const status = row.querySelector('.status-badge').textContent.trim();
                const payment = row.querySelector('.payment-status').textContent.trim();
                const bookingDate = row.cells[4].textContent.trim();
                const rowText = row.textContent.toLowerCase();

                let matches = true;

                // Status filter
                if (statusFilter && status !== statusFilter) {
                    matches = false;
                }

                // Payment filter
                if (paymentFilter && payment !== paymentFilter) {
                    matches = false;
                }

                // Date range filter
                if (dateFrom && bookingDate < dateFrom) {
                    matches = false;
                }
                if (dateTo && bookingDate > dateTo) {
                    matches = false;
                }

                // Search filter
                if (searchTerm && !rowText.includes(searchTerm)) {
                    matches = false;
                }

                if (matches) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show no data message if no rows visible
            const noData = document.querySelector('.no-data');
            if (noData) {
                noData.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('paymentFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        // Export bookings
        function exportBookings() {
            alert('Export functionality would be implemented here');
            // In real implementation, this would generate and download a CSV/PDF
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range to current month
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('dateTo').value = lastDay.toISOString().split('T')[0];

            // Add event listeners for filters
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('paymentFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        });
    </script>
{% endblock %}